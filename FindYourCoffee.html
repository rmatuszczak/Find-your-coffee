<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
	<link rel="stylesheet" href="coffee-style.css" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <title>Find Your Coffee!</title>
    <script>

	var myLocation;
	var pos; //position from the geolocation as LatLngObject
	var latitude; // Lat of a waypoint
	var longitude; // Lgt of a waypoint
	var destination_place_id = null; //destination from a search box

	//initialize map function start
	function initMap() {
		var directionsDisplay = new google.maps.DirectionsRenderer;
		var directionsService = new google.maps.DirectionsService;

// if geolocation allowed statement start	
  if (navigator.geolocation) { //GEO LOCATION, FINDS USERS LOCATION
    navigator.geolocation.getCurrentPosition(function(position) {

      pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      }
      map = new google.maps.Map(document.getElementById('map'), {
        center: myLocation,
        zoom: 13
      });
	  
	var input = document.getElementById('destination-input'); // get input from the searchBox
	var searchBox = new google.maps.places.SearchBox(input);   
   
    searchBox.addListener('places_changed', function() {
    var places = searchBox.getPlaces(); // get PlaceResult JSON object 
	destination_place_id = places[0].place_id; // set destination from the searchBox
	
    if (places.length == 0) {
      return;
	}
	});
	  
	directionsDisplay.setMap(map);
	directionsDisplay.setPanel(document.getElementById('text-directions')); 
	calculateAndDisplayRoute(directionsService, directionsDisplay);
  
  
	document.getElementById('places').addEventListener('change', function() {
    calculateAndDisplayRoute(directionsService, directionsDisplay);
    });
  
	document.getElementById('mode').addEventListener('change', function() {
    calculateAndDisplayRoute(directionsService, directionsDisplay);
	});
	  
	  
	  
	  
	  
      infoWindow = new google.maps.InfoWindow({
        map: map
      });
      infoWindow.setPosition(pos);
      infoWindow.setContent('You are here!');
      map.setCenter(pos);
      myLocation = pos; //Sets variable to geolocation lng and lat coordinates.

      var service = new google.maps.places.PlacesService(map);
      service.nearbySearch({
        location: myLocation, //Uses geolocation to find the following
        radius: 30000,
        types: ['cafe']
      }, processResults);
    })
  }; // if geolocation allowed statement start
}



function calculateAndDisplayRoute(directionsService, directionsDisplay) {
  var selectedMode = document.getElementById('mode').value;
  
   var waypts = [];
        var checkboxArray = document.getElementById('places');
        for (var i = 0; i < checkboxArray.length; i++) {
          if (checkboxArray.options[i].selected) {
            
			  var waypointLocation = checkboxArray[i].value;
			  
			  var fields = waypointLocation.split(/,/);  //splits the place's location into two strings to provite lat and lng coordinates
			  var lat = fields[0];							
			  var lgt = fields[1];
			  var fields2 = lat.split("(");
			  latitude =parseFloat(fields2[1]); // converts the first part of  the place's location string to float to provide lat
			  var fields3 = lgt.split(")");
			  longitude =parseFloat(fields3[0]); // converts the second of  the place's location string to float to provide lgt
			
			waypts.push({
			
              location:  {lat: latitude, lng: longitude},
              stopover: true
            });
          }
        }

  
  
	directionsService.route({
		origin: pos,  // current position in geocoding coordinates
		destination: {'placeId': destination_place_id},  // place id of a place chosen by a user
		waypoints: waypts,
		optimizeWaypoints: true,
		travelMode: google.maps.TravelMode[selectedMode]
	},
	function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    } else {
      window.alert('Directions request failed due to ' + status);
			}
		});
	}

	function processResults(results, status, pagination) {
		if (status !== google.maps.places.PlacesServiceStatus.OK) {
		return;
	}	else {
			createMarkers(results);

		if (pagination.hasNextPage) {
		var moreButton = document.getElementById('more');

		moreButton.disabled = false;

		moreButton.addEventListener('click', function() {
        moreButton.disabled = true;
        pagination.nextPage();
      });
    }
  }
}

	function createMarkers(places) {
	var bounds = new google.maps.LatLngBounds();
	var placesList = document.getElementById('places');

		for ( var i = 0, place; place = places[i]; i++) {
			var image = {
			  url: place.icon,
			  size: new google.maps.Size(71, 71),
			  origin: new google.maps.Point(0, 0),
			  anchor: new google.maps.Point(17, 34),
			  scaledSize: new google.maps.Size(25, 25)
			};

		var marker = new google.maps.Marker({
		  map: map,
		  icon: image,
		  title: place.name, 
		  position: place.geometry.location,
		});
	
	placesList.innerHTML += '<option value="'+ place.geometry.location +'">' + place.name + " - " + place.vicinity + '</li>';

    bounds.extend(place.geometry.location);
	
 } 
  map.fitBounds(bounds);
  
}


$(document).ready(function(){
			$("#display-directions").click(function(){
			$("#text-directions").toggle(1000);
			});
		});


    </script>
  
  </head>
  <body>
	<div id="destination-wrapper">
		<input id="destination-input" class="controls" type="text" placeholder="Enter your destination here">
	</div>
	<div id="mode-panel">
		<h2 id="label">Choose how you would like to travel </h2>
		<select multiple id="mode">
		  <option value="DRIVING">Driving</option>
		  <option value="WALKING">Walking</option>
		  <option value="BICYCLING">Bicycling</option>
		  <option value="TRANSIT">Public Transportation</option>
		</select>
   </div>
   
	<div id="waypoint-panel">
      <h2 id="label">Choose your favourite coffee place!</h2>
      <select multiple id="places"></select>
      <button id="more" class="button">More results</button>
	  <h2 id="label">Click the button below to display text directions to your destinations </h2>
	  <button id= "display-directions" class="button"> Text Directions</button> 
    </div>
	<div id="text-directions"></div>
    <div id="map"></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-d7qmZjlsvATZHoUeo0mWdvZJ56OreV8&signed_in=true&libraries=places&callback=initMap" async defer></script>
  </body>
</html>